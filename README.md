# Reposter Bot

Telegram-бот для автоматической пересылки сообщений из каналов-источников в каналы-склады.

## Особенности

- ✅ Поддержка альбомов (медиа-групп) с автоматической группировкой
- ✅ Работа в режиме бота или user-аккаунта (для пересылки без прав админа)
- ✅ Интерактивное управление через команды и кнопки
- ✅ Поддержка приватных каналов с invite-ссылками
- ✅ Модульная архитектура кода

## Установка

### Вариант 1: Через Git (рекомендуется)

1. Клонируйте репозиторий:
```bash
git clone https://github.com/ваш-username/reposter_bot.git
cd reposter_bot
```

2. Создайте виртуальное окружение:
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

### Вариант 2: Ручная установка

1. Скачайте архив проекта и распакуйте его
2. Перейдите в директорию проекта
3. Создайте виртуальное окружение и установите зависимости (как в варианте 1)

3. Получите API credentials:
   - Зайдите на https://my.telegram.org/apps
   - Создайте приложение и получите `API_ID` и `API_HASH`

4. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

Затем отредактируйте `.env` и заполните необходимые данные:
```env
MODE=bot
BOT_TOKEN=your_bot_token_here
API_ID=your_api_id
API_HASH=your_api_hash
SESSION_NAME=reposter_session
OWNER_IDS=123456789,987654321
DB_PATH=forwarder.db
LOG_FILE=bot.log
MAX_LOG_SIZE_MB=10
ALBUM_IDLE_SEC=4.5
```

**Важно:**
- `MODE` - режим работы: `auto` (рекомендуется), `bot` или `user`
- `BOT_TOKEN` - токен бота от @BotFather (обязателен для `auto` и `bot` режимов)
- `API_ID` и `API_HASH` - получите на https://my.telegram.org/apps (обязательны всегда)
- `USER_API_ID` и `USER_API_HASH` - **опционально**, для отдельного user аккаунта. Если не указаны, используются те же `API_ID`/`API_HASH`. Обычно можно оставить пустыми.
- `OWNER_IDS` - ID владельцев через запятую (обязательно! можно использовать старый формат `OWNER_ID` для одного владельца)

**Как работает автоматическое переключение:**
- Бот сначала пытается переслать через bot клиент
- При ошибке прав доступа автоматически пробует через user bot
- Для каждого канала-склада запоминается, какой клиент работает
- Это позволяет работать даже без прав админа в каналах

## Запуск

```bash
python main.py
```

## Команды

- `/start` - Начать работу с ботом
- `/help` - Справка по командам
- `/add_source` - Добавить канал-источник
- `/add_target` - Добавить канал-склад
- `/sources` - Список источников
- `/targets` - Список складов
- `/bind` - Создать связку источник → склад(ы)
- `/list` - Показать все связки
- `/remove` или `/unlink` - Удалить связку

## Структура проекта

```
reposter_bot/
├── config/          # Конфигурация и настройки
├── database/        # Работа с БД
├── handlers/        # Обработчики команд и сообщений
├── services/        # Бизнес-логика (пересылка)
├── utils/           # Утилиты (валидация, форматирование, логи)
├── main.py          # Точка входа
└── requirements.txt # Зависимости
```

## Режимы работы

### Auto Mode (`MODE=auto`) - **Рекомендуется**
- Автоматически использует bot для команд и пересылки
- При ошибках прав доступа автоматически переключается на user bot
- Не требует прав админа в каналах-складах
- Требует настройки user bot (опционально, можно использовать те же API_ID/API_HASH)

### Bot Mode (`MODE=bot`)
- Использует только Bot Token
- Требует, чтобы бот был добавлен в каналы
- Для пересылки бот должен быть админом в каналах-складах
- Можно добавить user bot для fallback (укажи `USER_API_ID` и `USER_API_HASH`)

### User Mode (`MODE=user`)
- Использует только user-аккаунт
- Может пересылать сообщения без прав админа
- Требует авторизацию через код из Telegram

## Как работает пересылка альбомов

1. При получении сообщения с `grouped_id` оно добавляется в буфер
2. Запускается таймер на `ALBUM_IDLE_SEC` секунд
3. Если приходит новое сообщение из того же альбома, таймер сбрасывается
4. После окончания таймера все сообщения альбома пересылаются одним запросом

## Лицензия

Проприетарная лицензия. Использование только для внутренних целей.
См. файл LICENSE для подробностей.
